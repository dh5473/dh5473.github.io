{"componentChunkName":"component---src-templates-post-template-tsx","path":"/python-series/synchronize-thread/","result":{"data":{"site":{"siteMetadata":{"title":"Donhyeok's Blog","description":"Python, FastAPI, AI/ML 등 개발 기술을 다루는 Donhyeok의 기술 블로그","siteUrl":"https://dh5473.github.io"}},"allMarkdownRemark":{"edges":[{"node":{"html":"<p>파이썬에서 GIL은 멀티스레딩 환경에서 단일 스레드만 파이썬 바이트코드를 실행하도록 제한합니다. 덕분에 참조 카운팅과 같은 메모리 관리 메커니즘을 안전하게 수행할 수 있습니다. 그렇다면 파이썬은 lock이 필요할까요? GIL은 중요한 역할을 하지만, 그렇다고 모든 동시성 문제를 해결해주지는 않습니다.</p>\n<p>다수의 스레드가 동일한 값을 읽고 쓰는 경우에는 여전히 lock이 필요합니다. 결국은 동기화 문제를 해결해야 한다는 것인데, 파이썬은 동기화를 위해 어떠한 프리미티브(primitives)를 제공하고 있을까요?</p>\n<p>간단한 설명과 함께 파이썬이 제공하는 스레드 동기화 도구들을 알아보겠습니다. 해당 내용은 <a href=\"https://betterprogramming.pub/synchronization-primitives-in-python-564f89fee732\" target=\"_blank\" rel=\"noopener noreferrer\">해외 블로그</a>와 <a href=\"https://docs.python.org/3/library/asyncio-sync.html\" target=\"_blank\" rel=\"noopener noreferrer\">파이썬 공식 문서</a>를 주로 참고하였습니다.\n<br></p>\n<h2>Lock</h2>\n<p>Lock은 파이썬에서 가장 심플한 동기화 프리미티브입니다. Lock은 locked와 unlocked 두 가지 상태만 존재합니다. 여기에 사용되는 메서드도 acquire()과 release()로 매우 단순합니다. 주의할 점은 unlocked 상태에서 release()를 호출할 경우 RunTimeError가 발생합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Lock<span class=\"token punctuation\">,</span> Thread\n\nlock <span class=\"token operator\">=</span> Lock<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntotal <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">add_one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> total\n\n    lock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    total <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    lock<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">add_two</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> total\n\n    lock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    total <span class=\"token operator\">+=</span> <span class=\"token number\">2</span>\n    lock<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\nthreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> func <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span>add_one<span class=\"token punctuation\">,</span> add_two<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    threads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    threads<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>RLock</h2>\n<p>기존의 Lock은 어떤 스레드가 lock을 획득한지 알지 못합니다. 누군가 락을 소유하고 있다면, 다른 스레드가 lock을 획득하려고 시도해도 block 됩니다. 심지어 스레드 자기 자신이 lock을 보유하고 있어도 마찬가지입니다.</p>\n<p>RLock(re-entrant lock)은 이러한 상황을 해결할 수 있습니다. 자세한 건 아래 코드를 통해 이해해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> threading\n\nnum <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\nlock <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span>Lock<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nlock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nnum <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\nlock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># block</span>\nnum <span class=\"token operator\">+=</span> <span class=\"token number\">2</span>\nlock<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\nlock <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span>RLock<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nlock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nnum <span class=\"token operator\">+=</span> <span class=\"token number\">3</span>\nlock<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># not block</span>\nnum <span class=\"token operator\">+=</span> <span class=\"token number\">4</span>\nlock<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nlock<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># call release once for each call to acquire</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>Semaphore</h2>\n<p>운영체제에서 필수적으로 등장하는 세마포어입니다. 세마포어의 경우 특정 수만큼의 스레드가 acquire()를 시도해야만 block 됩니다. 세마포어의 카운터는 acquire()가 호출될 때마다 감소하고, release()가 호출될 때마다 증가합니다.</p>\n<p>파이썬은 Semaphore와 BoundedSemaphore 클래스 두 가지를 제공합니다. Semaphore의 경우 release()에 대한 상한선이 없어서, 계속해서 release()가 가능합니다. 반면 BoundedSemaphore의 경우 설정해둔 최댓값을 넘어서는 release()를 호출할 경우 에러를 일으킵니다. 대부분의 경우 복잡한 프로그래밍 에러를 피하기 위해서, BoundedSemaphore를 선택하면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random<span class=\"token punctuation\">,</span> time\n<span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> BoundedSemaphore<span class=\"token punctuation\">,</span> Thread\n\nmax_items <span class=\"token operator\">=</span> <span class=\"token number\">5</span>  <span class=\"token comment\"># default 1 item</span>\ncontainer <span class=\"token operator\">=</span> BoundedSemaphore<span class=\"token punctuation\">(</span>max_items<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>ctime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">=</span><span class=\"token string\">\": \"</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            container<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produced an item.\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">except</span> ValueError<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Full, skipping.\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>ctime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">=</span><span class=\"token string\">\": \"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> container<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span>blocking<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consumed an item.\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Empty, skipping.\"</span><span class=\"token punctuation\">)</span>\n\n\nthreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nnloops <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Starting with %s itmes.\"</span> <span class=\"token operator\">%</span> max_items<span class=\"token punctuation\">)</span>\n\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>producer<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>consumer<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">,</span> nloops <span class=\"token operator\">+</span> max_items <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All done.\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>Event</h2>\n<p>Event 동기화 프리미티브는 스레드 사이에서 간단한 커뮤니케이터로 작동합니다. 스레드는 내부 플래그를 set() 혹은 clear()로 설정할 수 있으며, 다른 스레드들은 wait()를 통해 플래그가 set()이 될 때까지 대기합니다. wait() 메서드를 사용하면 플래그가 true로 설정될 때까지 block 상태로 대기합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random<span class=\"token punctuation\">,</span> time\n<span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Event<span class=\"token punctuation\">,</span> Thread\n\nevent <span class=\"token operator\">=</span> Event<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">waiter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s. Waiting for the flag to be set.\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        event<span class=\"token punctuation\">.</span>wait<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># blocks until the flag become true</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Wait complete at:\"</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>ctime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        event<span class=\"token punctuation\">.</span>clear<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># resets the flag</span>\n\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">setter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># sleeps for some time</span>\n        event<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\nthreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nnloops <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span>\n\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>waiter<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nthreads<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>setter<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> nloops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nthreads<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All done.\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>Condition</h2>\n<p>Condition 객체는 Event 객체보다 향상된 버전입니다. 스레드 간 커뮤니케이터로 동작할 뿐만 아니라, 다른 스레드들에게 프로그램의 상태 변환을 알릴 수 있는 notify() 메서드를 사용할 수 있습니다.</p>\n<p>예를 들어 리소스의 가용성에 대한 정보를 보낼 수 있습니다. 다른 스레드들은 wait()으로 대기하고 있다가 condition 객체의 lock을 획득하려고 합니다. 아래 코드에서는 producer와 consumer 사이의 간단한 예시를 보여주고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random<span class=\"token punctuation\">,</span> time\n<span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Condition<span class=\"token punctuation\">,</span> Thread\n\ncondition <span class=\"token operator\">=</span> Condition<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nbox <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">,</span> nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        condition<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        num <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>randint<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n        box<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produced:\"</span><span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">)</span>\n        condition<span class=\"token punctuation\">.</span>notify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># send a notification to consumer</span>\n        condition<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">,</span> nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        condition<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">while</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Nothing to consume, waiting...\"</span><span class=\"token punctuation\">)</span>\n            condition<span class=\"token punctuation\">.</span>wait<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># wait for the notification from producer</span>\n        num <span class=\"token operator\">=</span> box<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consumed:\"</span><span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">)</span>\n        condition<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\nthreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nnitems <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span>\n\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>consumer<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">,</span> nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nthreads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>producer<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">,</span> nitems<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All done.\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>Barrier</h2>\n<p>Barrier는 특정 수의 스레드가 모두 barrier 지점에 도달할 때까지 기다리는 동기화 프리미티브입니다. 모든 스레드가 도착하면 동시에 계속 진행됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random<span class=\"token punctuation\">,</span> time\n<span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Barrier<span class=\"token punctuation\">,</span> Thread\n\nbarrier <span class=\"token operator\">=</span> Barrier<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># wait for 3 threads</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">worker</span><span class=\"token punctuation\">(</span>barrier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># do some work</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>randrange<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    worker_id <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span>current_thread<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ident\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Worker </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>worker_id<span class=\"token punctuation\">}</span></span><span class=\"token string\"> finished work, waiting at barrier...\"</span></span><span class=\"token punctuation\">)</span>\n    \n    barrier<span class=\"token punctuation\">.</span>wait<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># wait until all threads reach this point</span>\n    \n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Worker </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>worker_id<span class=\"token punctuation\">}</span></span><span class=\"token string\"> passed the barrier!\"</span></span><span class=\"token punctuation\">)</span>\n\n\nthreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    threads<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>worker<span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>barrier<span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    threads<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> thread <span class=\"token keyword\">in</span> threads<span class=\"token punctuation\">:</span>\n    thread<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All workers finished.\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h2>Timer</h2>\n<p>Timer는 지정된 시간이 지난 후에 함수를 실행하는 스레드입니다. 일종의 지연 실행 메커니즘을 제공합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Timer\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">greet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello from Timer!\"</span><span class=\"token punctuation\">)</span>\n\n\ntimer <span class=\"token operator\">=</span> Timer<span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> greet<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># execute greet() after 3 seconds</span>\ntimer<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Timer started, waiting...\"</span><span class=\"token punctuation\">)</span>\ntimer<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"All done.\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>이러한 동기화 프리미티브들은 각각 다른 상황에서 유용하게 사용됩니다. Lock과 RLock은 기본적인 상호 배제를 위해, Semaphore는 리소스 풀 관리를 위해, Event와 Condition은 스레드 간 통신을 위해, Barrier는 스레드 동기화를 위해 사용됩니다.</p>\n<h2>참고 자료</h2>\n<ul>\n<li><a href=\"https://betterprogramming.pub/synchronization-primitives-in-python-564f89fee732\" target=\"_blank\" rel=\"noopener noreferrer\">Synchronization Primitives in Python</a></li>\n<li><a href=\"https://docs.python.org/3/library/threading.html\" target=\"_blank\" rel=\"noopener noreferrer\">Python 공식 문서 - Threading</a></li>\n<li><a href=\"https://docs.python.org/3/library/asyncio-sync.html\" target=\"_blank\" rel=\"noopener noreferrer\">Python 공식 문서 - Asyncio Sync</a></li>\n</ul>","fields":{"slug":"/python-series/synchronize-thread/"},"frontmatter":{"title":"[Python] Thread Synchronization","summary":"Python의 다양한 스레드 동기화 도구들과 활용 방법에 대해 알아봅니다.","date":"2025.02.27.","rawDate":"2025-02-27","category":"Python","thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABV0lEQVR42qVSzU7CQBDuO3n2IbzoM3jwoB49eyLh5gNoGtR4wUOPbSIppJv+mCAQIG1pBIuEpCkNtM12fxyKkoYIJjLZbSbzfd90dmYEvocJcFlu2xg7UOEnzPLzzd6Qrb8bWYQ0Ix/BPMGkqCySkiRJ03QtLiYSJOv98Orp+lFd/R1jHEURAJRSiLiuaxhGv98HP47jxWIBcSAQQqbTqXBclg8uns9vbvn8njL61moBu9Fo+L7f6/UkSVJVtVar6bpuWZZpmoBqmmbb9rLs0sOdhsre6yn3TjI8R0jvdruiKHY6HeCBDCE0GAyq1Wq9Xm+325VKxXEcgJbikVvin0dsdMlCGcqWZRnSB0HQbDYVRRkOh57nhWE4mUzs3MbjMaBQ81JMZy+Zc0YjlLeBwiPh2eBD2SD7Y87QF4wJJRnntDghaAnbaaslYb8OecPfumF7ree/xV9Sfd5KloGmkQAAAABJRU5ErkJggg=="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/8a5ef884fcdafd689ceeef85a9885b13/fe930/python-logo.png","srcSet":"/static/8a5ef884fcdafd689ceeef85a9885b13/966f0/python-logo.png 750w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/00143/python-logo.png 1080w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/d0501/python-logo.png 1366w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/a5a7d/python-logo.png 1920w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/fe930/python-logo.png 2400w","sizes":"(min-width: 2400px) 2400px, 100vw"},"sources":[{"srcSet":"/static/8a5ef884fcdafd689ceeef85a9885b13/2af88/python-logo.avif 750w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/b916c/python-logo.avif 1080w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/33b5a/python-logo.avif 1366w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/4ab22/python-logo.avif 1920w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/b0cf8/python-logo.avif 2400w","type":"image/avif","sizes":"(min-width: 2400px) 2400px, 100vw"},{"srcSet":"/static/8a5ef884fcdafd689ceeef85a9885b13/5c33e/python-logo.webp 750w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/96dc2/python-logo.webp 1080w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/38892/python-logo.webp 1366w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/0a5b1/python-logo.webp 1920w,\n/static/8a5ef884fcdafd689ceeef85a9885b13/4b935/python-logo.webp 2400w","type":"image/webp","sizes":"(min-width: 2400px) 2400px, 100vw"}]},"width":2400,"height":1500}},"publicURL":"/static/8a5ef884fcdafd689ceeef85a9885b13/python-logo.png"}}}}]}},"pageContext":{"slug":"/python-series/synchronize-thread/"}},"staticQueryHashes":[],"slicesMap":{}}